Add cache below txn/logging layer

Add an icache, but simpler now

Test for reallocating inode before shrunk

directories ls: if lock ordering problem, return what we have read so far

error codes
  write cnt = 0 should return which error happened

log absorption

test out of fs space

check that inodes are not modified on disk on abort
  e.g., nlink on failure to add to dir

mtime

performance measurements

end-to-end tests for recovery

goosify

log-by-pass writes

simplify allocator
  goal: avoid locking regions; no search for free object as part of txn
    txn never issues reads to bitmaps (except at recovery time)
    txn contains single-bit writes to freed or allocated blocks
  in-memory allocator state: list of free object IDs (block#s, inode#s)
    probably map[uint64]struct{}
  invariant: in-memory allocator state (set of free object IDs) is a
    subset of the on-disk allocator state (set of free bits in bitmap)
  allocation returns one of the in-memory IDs, and marks it in-use
  after allocating an object ID, add txn write to the allocated bitmap bit
  if txn aborts, return allocated IDs to the in-memory allocator state
  when freeing object, add txn write to the freed bitmap bit
  after txn commits, put freed IDs into the in-memory allocator state
  on recovery, populate in-memory allocator state from on-disk bitmap

== some performance

--- small ---

Linux:
export /srv/nfs
sudo mount --bind /tmp/nfs /srv/nfs/bench
sudo mount -t nfs -o vers=3 localhost:/srv/nfs/bench /mnt/nfs
[goose-nfs (master)]$ ~/hack/fscq-impl/bench/smallfile /mnt/nfs/bench/
10440 files per 1000034 usec
   much time spent in LookupName (0.93s out of 2.37)

Goose:

[goose-nfs (master)]$ go test -v -cpuprofile cpu.prof -memprofil
goos: linux
goarch: amd64
pkg: github.com/mit-pdos/goose-nfsd
BenchmarkSmall-8           26823             40653 ns/op
PASS
ok      github.com/mit-pdos/goose-nfsd  3.316s


[goose-nfs (master)]$  ~/hack/fscq-impl/bench/smallfile /mnt/nfs
3068 files per 1000284 usec
[goose-nfs (master)]$ ls /mnt/nfs

--- large ---

Linux:

[goose-nfs (master)]$ showmount -e
Export list for fk6x1:
/srv/nfs/bench localhost
/srv/nfs       localhost
[goose-nfs (master)]$ sudo mount -t nfs -o vers=3 localhost:/srv/nfs/bench /mnt/nfs
[goose-nfs (master)]$ ~/hack/fscq-impl/bench/largefile /mnt/nfs
makefile 50 MB 40476 usec throughput 1264947.1 KB/s
writefile 50 MB 30536 usec throughput 1676709.5 KB/s

Goose:

[goose-nfs (master)]$ sudo mount -t nfs -o vers=3 localhost:/ /mnt/nfs
[goose-nfs (master)]$ ~/hack/fscq-impl/bench/largefile  /mnt/nfs
makefile 50 MB 468844 usec throughput 109204.8 KB/s
writefile 50 MB 308590 usec throughput 165915.9 KB/s
[goose-nfs (master)]$

[goose-nfs (master)]$ ~/hack/fscq-impl/bench/largefile  /mnt/nfs
makefile 50 MB 408314 usec throughput 125393.7 KB/s
writefile 50 MB 238106 usec throughput 215030.3 KB/s

[goose-nfs (master)]$ go test -v  -bench Large -run=^$ 
goos: linux
goarch: amd64
pkg: github.com/mit-pdos/goose-nfsd
BenchmarkLargeFile-8           7         150782653 ns/op

--- running on ext4 over image in tmpfs

$ dd if=/dev/zero of=nfs3.img bs=4K count=100000
$ mkfs -t ext4 nfs3.img
$ sudo mount -t ext4 -o loop /tmp/nfs3.img /srv/nfs/bench
$ sudo systemctl start nfs-server.service
$ sudo mount -t nfs -o vers=3 localhost:/srv/nfs/bench /mnt/nfs
$ sudo chmod 777 /srv/nfs/bench


ext4 with log-by-pass and delayed allocation

[goose-nfs (master)]$  ~/hack/fscq-impl/bench/smallfile /mnt/nfs/
4478 files per 1000176 usec

[goose-nfs (master)]$ ~/hack/fscq-impl/bench/largefile /mnt/nfs
makefile 50 MB 98050 usec throughput 522182.6 KB/s
writefile 50 MB 102683 usec throughput 498622.0 KB/s

--- running on ext3 over image in tmpfs

[tmp]$ rm nfs3.img 
[tmp]$ dd if=/dev/zero of=nfs3.img bs=4K count=100000
[tmp]$ mkfs -t ext3 nfs3.img
[tmp]$ sudo mount -t ext3 -o data=journal,sync -o loop /tmp/nfs3.img /srv/nfs/bench
[tmp]$ sudo systemctl start nfs-server.service
[tmp]$ sudo mount -t nfs -o vers=3 localhost:/srv/nfs/bench /mnt/nfs
[tmp]$ sudo chmod 777 /srv/nfs/bench

[bench (master)]$ ~/hack/fscq-impl/bench/largefile /mnt/nfs
makefile 50 MB 295276 usec throughput 173397.1 KB/s
writefile 50 MB 168222 usec throughput 304359.7 KB/s

[bench (master)]$ ~/hack/fscq-impl/bench/smallfile /mnt/nfs
4286 files per 1000016 usec
[bench (master)]$

--- running goose-nfsd over file disk image in tmpfs

[tmp]$ ~/hack/fscq-impl/bench/largefile  /mnt/nfs
makefile 50 MB 484000 usec throughput 105785.1 KB/s
writefile 50 MB 366641 usec throughput 139646.1 KB/s

[tmp]$ ~/hack/fscq-impl/bench/smallfile /mnt/nfs/
2776 files per 1000213 usec

with eager logging (i.e., broadcast logger at end of memWrite)

[goose-nfs (master)]$ ~/hack/fscq-impl/bench/largefile  /mnt/nfs
makefile 50 MB 492391 usec throughput 103982.4 KB/s
writefile 50 MB 546629 usec throughput 93665.0 KB/s

[goose-nfs (master)]$ sudo mount -t nfs -o vers=3 localhost:/ /mnt/nfs
[goose-nfs (master)]$ ~/hack/fscq-impl/bench/smallfile /mnt/nfs/
2721 files per 1000128 usec
